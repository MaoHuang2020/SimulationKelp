---
title: "Add_Loops"
author: "MaoHuang"
date: "3/10/2020"
output: html_document
#runtime: shiny 
---

## Founder population parameters
```{r, echo=TRUE,results="hide",message=FALSE, warning=FALSE}
library(AlphaSimR)
```

```{r founder parameters}
Ne=60       # Historical effective population size, estimated via E(r2)=1/(1+4*Ne*c)
nInd<-800   # Number of founders
nChr<-31    # Number of chr
segSites<-500   # Number of segregating sites per chromosome
Sporo_ploidy<-2L   # Ploidy
bp<-1e+08       # Base pair length of chromosome
genLen=1        # Genetic length of chromosome in Morgans

nSnpPerChr<-100  # Number of SNP per chromosome
nQtlPerChr<-100  # Number of QTL per chromosome
mean_Trait<-0    # Trait mean
var_Trait<-1     # Trait variance
varE<-2          # *** This is starting H=0.33,  H=0.1 or H=0.5

```

**Number of individuals to  phenotype *400* vs *1000* **
```{r}
nCrosses<-400  ## ?? Use shiny to render the number of crosses
nDH<-1         
##OR
# nCrosses<-500
# nDH<-2
n_gp<-nCrosses/2
```

**Number of reps and cycles(years) **
```{r}
nrep<-1  ## ?? Use shiny to render
cycles <-3
```

## Define the selection *Random* vs *Top*
```{r Simulation}
selection<-"rand" ## ?? Use shiney to render?

### OR
## Select Random or Tops 100 for the Sporophytes
Rand<-function (Population){
  Spj_s<-selectInd(Population,nInd=100,trait=1,use="rand",simParam=SP)
  return(list=Spj_s)
}

Tops<- function(Population){
  Spj_s<-selectInd(Population,nInd=100,trait=1,selectTop=TRUE,use="pheno",simParam=SP)	
 	return(llist=Spj_s)
}
  
  
```



## Running the reps and cycles
```{r}

Mean_g_Rep<-matrix(nrow=cycles,ncol=nrep)
Sd_g_Rep<-matrix(nrow=cycles,ncol=nrep)
     founderPop<-runMacs2(nInd=nInd,nChr=nChr,segSites=segSites,Ne=Ne,bp=bp,genLen=1,inbred=TRUE,ploidy=Sporo_ploidy, returnCommand = FALSE, nThreads = NULL)
```  
   
```{r}     
for (i in 1:nrep){

    # Founder Pop should be here
  
    SP = SimParam$new(founderPop)
    SP$addTraitA(nQtlPerChr=nQtlPerChr, mean=mean_Trait,var=var_Trait,corA=NULL)
    SP$addSnpChip(nSnpPerChr=nSnpPerChr)
    SP$setGender("yes_sys")
    SP$setTrackRec(TRUE)
    
    pop <- newPop(founderPop, simParam=SP)
    pop<-setPheno(pop,varE=varE,simParam=SP)
    genMean=meanG(pop)
    
    generation<- vector(length=(cycles+1),mode="list")
    generation[[1]]<-pop   ### cycle 0, founder pop

    GP0_DH<-makeDH(generation[[1]],nDH=nDH,simParam=SP)	
	  GP0_DH_all<-pullQtlGeno(GP0_DH)	
	    dim(GP0_DH_all)
	 
 GS<-NULL
 GEBV<-NULL
 
 Sporo<-NULL
 Sporo_s<-NULL
 GP_DH<-NULL
 
for (j in 1:cycles){ 
 
 if (j<=2){
## Year 2, the same scheme as in Year 1
## Randomly select 200 as female, then randomly select another 200 as male
females<-selectInd(pop=GP0_DH,gender="F",nInd=n_gp,trait=1,use="rand",simParam=SP)
males<-selectInd(pop=GP0_DH,gender="M",nInd=n_gp,trait=1,use="rand",simParam=SP)	

GP_F<-row.names(pullQtlGeno(females))
GP_M<-row.names(pullQtlGeno(males))

GP_F_2<-GP_F[sample(length(GP_F))]	  					 
GP_M_2<-GP_M[sample(length(GP_M))] 					 

GP_Fs<-c(GP_F,GP_F_2)
GP_Ms<-c(GP_M,GP_M_2)

crossPlan<-cbind(GP_Fs,GP_Ms)

## Cross to create 400 Spj
Spj<-makeCross(GP0_DH,crossPlan=crossPlan,simParam=SP)
Spj<-setPheno(Spj,varE=2,simParam=SP)
Sporo<-c(Sporo,Spj)

## Select amongst Spj
Spj_s<-Rand(Sporo[[j]])

            ### !!! OR			 
            # Tops(Sporo[[j]]
            ####		
Sporo_s<-c(Sporo_s,Spj_s)

## Make GP DH using Sporo_s
GP_DHj<-makeDH(Sporo_s[[j]],nDH=25,simParam=SP)	### !!!
GP_DH<-c(GP_DH,GP_DHj)
print(j)

  } else if (j>2) {
    print (j)
            TP_j<-mergePops(Sporo)  
            GS_j<-RRBLUP(TP_j,traits=1,simParam=SP)  ### TP only has info from 1:(j-1)
            
            ## GEBVs on GP(y-1)s
            GEBV_j<-setEBV(GP_DH[[j-2]],GS_j,simParam=SP)  ### Use the GP_DH two years ago
            
            females<-selectInd(pop=GEBV_j,gender="F",nInd=n_gp,selectTop=TRUE,trait=1,use="ebv",simParam=SP)
            males<-selectInd(pop=GEBV_j,gender="M",nInd=n_gp,selectTop=TRUE,trait=1,use="ebv",simParam=SP)
            
            GP_F<-row.names(pullQtlGeno(females))
            GP_M<-row.names(pullQtlGeno(males))
            
            GP_F_2<-GP_F[sample(length(GP_F))]
            GP_M_2<-GP_M[sample(length(GP_M))]
            
            GP_Fs<-c(GP_F,GP_F_2)
            GP_Ms<-c(GP_M,GP_M_2)
            
            crossPlan<-cbind(GP_Fs,GP_Ms)
            
            ## Cross to create Sporoy
            Sporo_j<-makeCross(GEBV_j,crossPlan=crossPlan,simParam=SP)
            Sporo_j<-setPheno(Sporo_j,varE=2,simParam=SP)
            
            Sporo<-c(Sporo,Sporo_j)
            
            ## Select amongst Sporoy 
            Sporo_js<-Rand(Sporo[[j]])
                          ### !!! OR			 
                  # Sporo_js<-selectInd(Sporo[3][j],nInd=100,trait=1,selectTop=TRUE,use="pheno",simParam=SP)	
                  ####	
            Sporo_s<-c(Sporo_s,Sporo_js)
            
      
            
            ## Make GP_DH_j using Sporo_s
            GP_DH_j<-makeDH(Sporo_s[[j]],nDH=25,simParam=SP)
            GP_DH<-c(GP_DH,GP_DH_j)
            
         print(j)   
  }
  
mean_g1<-unlist(lapply(Sporo,meanG))
sd_g1<-sqrt(unlist(lapply(Sporo,varG)))
        
}      
 
Mean_g_Rep[,i]<-mean_g1
Sd_g_Rep[,i]<-sd_g1

 }
        
Mean_g<-rowMeans(Mean_g_Rep)
Sd_g<-rowMeans(Sd_g_Rep)

Mean_Sd<-cbind(Mean_g,Sd_g)

write.csv(Mean_g_Rep,paste(selection,"_Mean_g_WithRep.csv",sep=""))
write.csv(Sd_g_Rep,paste(selection,"_Sd_g_WithRep.csv",sep=""))
write.csv(Mean_Sd,paste(selection,"_Mean_g_Sd_AverageOverRep.csv",sep=""))


```
